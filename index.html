<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Atari Sound Improvizator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: #000; color:#00ff00; font-family: 'VT323', monospace; }
        .container { max-width: 1000px; margin: 0 auto; padding: 24px; text-align: center; }
        h1, h2 { margin: 16px 0; }
        button { background: #111; color: #00ff00; border: 1px solid #00ff00; font-family: 'VT323', monospace; font-size: 18px; margin: 6px 6px; padding: 6px 18px; cursor: pointer; }
        button:hover { background: #222; color: #fff; border-color: #fff;}
        .sound-buttons { margin-top:24px; margin-bottom:24px; display: flex; flex-wrap:wrap; justify-content:center;}
        .sound-buttons button { margin: 4px; }
        .seq-section { margin:38px 0; }
        #seq-matrix { display:inline-block; border:2px solid #00ff00; background:#222; }
        .seq-row { display:flex; }
        .seq-cell { width:28px; height:28px; border:1px solid #333; box-sizing:border-box; cursor:pointer; background:#111; }
        .seq-cell.active { background:#00ff00; }
        #seq-controls { margin:10px 0; }
        #seq-controls label { margin:0 6px 0 10px; }
        #seq-current-step { color:#ff0; font-weight:bold; font-size:16px; }
        @media (max-width:1000px) { .container{padding:8px;} .seq-cell{width:18px;height:18px;} }
    </style>
</head>
<body>
    <div class="container">
        <h1>ATARI SOUND IMPROVIZATOR</h1>
        <div class="sound-buttons" id="sound-buttons">
            <!-- Sound buttons automatski -->
        </div>
        <button id="play-random">► RANDOM PLAY</button>
        <div class="seq-section">
            <h2>MATRIČNI SEQUENCER</h2>
            <div id="seq-controls">
                <button id="seq-play">► PLAY SEQUENCER</button>
                <button id="seq-stop">■ STOP</button>
                <button id="seq-clear">Obriši matricu</button>
                <label>Tempo (BPM): <input type="number" id="seq-bpm" value="120" style="width:50px"></label>
                <span id="seq-current-step"></span>
            </div>
            <div id="seq-matrix"></div>
        </div>
    </div>
    <script>
        // --- SOUND ENGINE ---
        const soundDefs = [
            {name:'Atari Beep', fn:atariBeep},
            {name:'Laser', fn:laser},
            {name:'Explosion', fn:explosion},
            {name:'Melody', fn:melody},
            {name:'Space', fn:space},
            {name:'Noise', fn:noise},
            {name:'Bass', fn:bass},
            {name:'Kick', fn:kick},
            {name:'Snare', fn:snare},
            {name:'Saw', fn:saw},
            {name:'Sine', fn:sine},
            {name:'Triangle', fn:triangle},
            {name:'Sweep', fn:sweep},
            {name:'Sweep Down', fn:()=>sweep(false)},
            {name:'Sweep Up', fn:()=>sweep(true)},
            {name:'Random', fn:randomSound}
        ];
        function play(fn) {
            fn();
        }
        // --- SOUND FUNCTIONS ---
        function atariBeep() {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type='square'; osc.frequency.value=440; gain.gain.value=0.15;
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); setTimeout(()=>{osc.stop();ctx.close();},180);
        }
        function laser() {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const osc = ctx.createOscillator(), gain=ctx.createGain();
            osc.type='sawtooth'; osc.frequency.setValueAtTime(1200,ctx.currentTime);
            osc.frequency.linearRampToValueAtTime(200,ctx.currentTime+0.27);
            gain.gain.setValueAtTime(0.2,ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0,ctx.currentTime+0.28);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime+0.3); osc.onended=()=>ctx.close();
        }
        function explosion() {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const buffer=ctx.createBuffer(1,ctx.sampleRate*0.35,ctx.sampleRate);
            const data=buffer.getChannelData(0);
            for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.pow(1-i/data.length,2.5);
            const noise=ctx.createBufferSource(); noise.buffer=buffer;
            const gain=ctx.createGain();
            gain.gain.setValueAtTime(0.4,ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0,ctx.currentTime+0.35);
            noise.connect(gain); gain.connect(ctx.destination);
            noise.start(); noise.stop(ctx.currentTime+0.36); noise.onended=()=>ctx.close();
        }
        function melody() {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const notes = [220,330,440,660,880,990,1244,1760];
            let t=ctx.currentTime;
            for(let i=0;i<10;i++) {
                let osc=ctx.createOscillator(),gain=ctx.createGain();
                osc.type=['square','triangle','sawtooth'][Math.floor(Math.random()*3)];
                osc.frequency.value=notes[Math.floor(Math.random()*notes.length)];
                gain.gain.value=0.14;
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(t+i*0.19); osc.stop(t+i*0.19+0.15);
                osc.onended=()=>gain.disconnect();
            }
            setTimeout(()=>ctx.close(),2200);
        }
        function space() {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const buffer=ctx.createBuffer(1,ctx.sampleRate*0.5,ctx.sampleRate);
            const data=buffer.getChannelData(0);
            for(let i=0;i<data.length;i++) data[i]=Math.sin(i*0.019)*Math.random()*(1-i/data.length);
            const noise=ctx.createBufferSource(); noise.buffer=buffer;
            const gain=ctx.createGain();
            gain.gain.setValueAtTime(0.23,ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0,ctx.currentTime+0.5);
            noise.connect(gain); gain.connect(ctx.destination);
            noise.start(); noise.stop(ctx.currentTime+0.51); noise.onended=()=>ctx.close();
        }
        function noise() {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const buffer=ctx.createBuffer(1,ctx.sampleRate*0.22,ctx.sampleRate);
            const data=buffer.getChannelData(0);
            for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
            const noise=ctx.createBufferSource(); noise.buffer=buffer;
            const gain=ctx.createGain();
            gain.gain.setValueAtTime(0.16,ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0,ctx.currentTime+0.22);
            noise.connect(gain); gain.connect(ctx.destination);
            noise.start(); noise.stop(ctx.currentTime+0.23); noise.onended=()=>ctx.close();
        }
        function bass() {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const osc=ctx.createOscillator(),gain=ctx.createGain();
            osc.type='square'; osc.frequency.value=60;
            gain.gain.setValueAtTime(0.32,ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0,ctx.currentTime+0.18);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime+0.2); osc.onended=()=>ctx.close();
        }
        function kick() {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const osc=ctx.createOscillator(),gain=ctx.createGain();
            osc.type='sine'; osc.frequency.setValueAtTime(155,ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40,ctx.currentTime+0.14);
            gain.gain.setValueAtTime(0.32,ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0,ctx.currentTime+0.13);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime+0.15); osc.onended=()=>ctx.close();
        }
        function snare() {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const buffer=ctx.createBuffer(1,ctx.sampleRate*0.15,ctx.sampleRate);
            const data=buffer.getChannelData(0);
            for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*(1-i/data.length);
            const noise=ctx.createBufferSource(); noise.buffer=buffer;
            const gain=ctx.createGain();
            gain.gain.setValueAtTime(0.25,ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0,ctx.currentTime+0.12);
            noise.connect(gain); gain.connect(ctx.destination);
            noise.start(); noise.stop(ctx.currentTime+0.14); noise.onended=()=>ctx.close();
        }
        function saw() {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const osc=ctx.createOscillator(),gain=ctx.createGain();
            osc.type='sawtooth'; osc.frequency.value=280;
            gain.gain.value=0.17; osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); setTimeout(()=>{osc.stop();ctx.close();},170);
        }
        function sine() {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const osc=ctx.createOscillator(),gain=ctx.createGain();
            osc.type='sine'; osc.frequency.value=660;
            gain.gain.value=0.15; osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); setTimeout(()=>{osc.stop();ctx.close();},150);
        }
        function triangle() {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const osc=ctx.createOscillator(),gain=ctx.createGain();
            osc.type='triangle'; osc.frequency.value=440;
            gain.gain.value=0.13; osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); setTimeout(()=>{osc.stop();ctx.close();},160);
        }
        function sweep(up=true) {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const osc=ctx.createOscillator(),gain=ctx.createGain();
            osc.type='triangle';
            if(up) {
                osc.frequency.setValueAtTime(150,ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(990,ctx.currentTime+0.36);
            } else {
                osc.frequency.setValueAtTime(990,ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(150,ctx.currentTime+0.36);
            }
            gain.gain.setValueAtTime(0.18,ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0,ctx.currentTime+0.35);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime+0.37); osc.onended=()=>ctx.close();
        }
        function randomSound() {
            const arr = [atariBeep,laser,explosion,melody,space,noise,bass,kick,snare,saw,sine,triangle,sweep];
            arr[Math.floor(Math.random()*arr.length)]();
        }

        // --- SOUND BUTTONS ---
        const soundButtonsDiv = document.getElementById('sound-buttons');
        soundDefs.forEach((def,i) => {
            const btn = document.createElement('button');
            btn.textContent = def.name;
            btn.onclick = () => play(def.fn);
            soundButtonsDiv.appendChild(btn);
        });
        document.getElementById('play-random').onclick = () => {
            let n = 8+Math.floor(Math.random()*8);
            let arr = [];
            for(let i=0;i<n;i++) arr.push(soundDefs[Math.floor(Math.random()*soundDefs.length)].fn);
            let t=0;
            arr.forEach((fn,ix)=>{
                setTimeout(()=>play(fn), t);
                t+=150+Math.random()*300;
            });
        };

        // --- MATRIX SEQUENCER ---
        const seqRows = soundDefs.length; // 16
        const seqSteps = 16;
        let seqMatrix = JSON.parse(localStorage.getItem('seqMatrix')||'null');
        if(!seqMatrix) seqMatrix = Array(seqRows).fill().map(()=>Array(seqSteps).fill(false));
        let seqPlaying = false, seqStep=0, seqTimer=null;
        const seqMatrixDiv = document.getElementById('seq-matrix');
        function drawSeqMatrix() {
            seqMatrixDiv.innerHTML = '';
            for(let r=0;r<seqRows;r++) {
                const row = document.createElement('div');
                row.className = 'seq-row';
                for(let s=0;s<seqSteps;s++) {
                    const cell = document.createElement('div');
                    cell.className = 'seq-cell'+(seqMatrix[r][s]?' active':'');
                    if(seqPlaying && s===seqStep) cell.style.border='2px solid #ff0';
                    cell.onclick = ()=> {
                        seqMatrix[r][s]=!seqMatrix[r][s];
                        localStorage.setItem('seqMatrix',JSON.stringify(seqMatrix));
                        drawSeqMatrix();
                    };
                    row.appendChild(cell);
                }
                seqMatrixDiv.appendChild(row);
            }
        }
        drawSeqMatrix();

        document.getElementById('seq-clear').onclick = function() {
            seqMatrix = Array(seqRows).fill().map(()=>Array(seqSteps).fill(false));
            localStorage.setItem('seqMatrix',JSON.stringify(seqMatrix));
            drawSeqMatrix();
        };

        function seqPlayStep() {
            let bpm = parseInt(document.getElementById('seq-bpm').value)||120;
            let interval = 60000/bpm/2;
            for(let r=0;r<seqRows;r++) if(seqMatrix[r][seqStep]) play(soundDefs[r].fn);
            document.getElementById('seq-current-step').textContent = 'STEP: '+(seqStep+1)+'/'+seqSteps;
            drawSeqMatrix();
            seqStep = (seqStep+1)%seqSteps;
            if(seqPlaying) seqTimer = setTimeout(seqPlayStep, interval);
        }
        document.getElementById('seq-play').onclick = function() {
            if(seqPlaying) return;
            seqPlaying=true; seqStep=0;
            seqPlayStep();
        };
        document.getElementById('seq-stop').onclick = function() {
            seqPlaying=false;
            if(seqTimer) clearTimeout(seqTimer);
            document.getElementById('seq-current-step').textContent = '';
            drawSeqMatrix();
        };

        // --- AUTOSAVE MATRIX ---
        document.getElementById('seq-bpm').onchange = function() {
            localStorage.setItem('seqBpm',this.value);
        };
        let savedBpm = localStorage.getItem('seqBpm');
        if(savedBpm) document.getElementById('seq-bpm').value = savedBpm;
    </script>
</body>
</html>
